!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@angular/core"),require("assert"),require("buffer"),require("@ngeth/utils"),require("secp256k1"),require("crypto-browserify"),require("uuid"),require("scrypt.js"),require("@ngeth/provider"),require("rxjs"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("@ngeth/wallet",["exports","@angular/core","assert","buffer","@ngeth/utils","secp256k1","crypto-browserify","uuid","scrypt.js","@ngeth/provider","rxjs","rxjs/operators"],r):r((e.ngeth=e.ngeth||{},e.ngeth.wallet={}),e.ng.core,null,null,null,null,null,null,null,null,e.rxjs,e.rxjs.operators)}(this,function(e,r,n,l,b,h,k,j,S,t,o,i){"use strict";S=S&&S.hasOwnProperty("default")?S["default"]:S;var s=function(){function e(){}return e.decorators=[{type:r.NgModule}],e}(),a=function(){function e(){}return e.prototype.encode=function(e){if(e instanceof Array){for(var r=[],t=0;t<e.length;t++)r.push(this.encode(e[t]));var n=l.Buffer.concat(r);return l.Buffer.concat([this.encodeLength(n.length,192),n])}return 1===(e=this.toBuffer(e)).length&&e[0]<128?e:l.Buffer.concat([this.encodeLength(e.length,128),e])},e.prototype.safeParseInt=function(e,r){if("00"===e.slice(0,2))throw new Error("invalid RLP: extra zeros");return parseInt(e,r)},e.prototype.encodeLength=function(e,r){if(e<56)return l.Buffer.from([e+r]);var t=this.intToHex(e),n=t.length/2,o=this.intToHex(r+55+n);return l.Buffer.from(o+t,"hex")},e.prototype.decode=function(e,r){if(!e||0===e.length)return l.Buffer.from([]);e=this.toBuffer(e);var t=this._decode(e);return r?t:(n.equal(t.remainder.length,0,"invalid remainder"),t.data)},e.prototype.getLength=function(e){if(!e||0===e.length)return l.Buffer.from([]);var r=(e=this.toBuffer(e))[0];if(r<=127)return e.length;if(r<=183)return r-127;if(r<=191)return r-182;if(r<=247)return r-191;var t=r-246;return t+this.safeParseInt(e.slice(1,t).toString("hex"),16)},e.prototype._decode=function(e){var r,t,n,o,i,s=[],a=e[0];if(a<=127)return{data:e.slice(0,1),remainder:e.slice(1)};if(a<=183){if(r=a-127,n=128===a?l.Buffer.from([]):e.slice(1,r),2===r&&n[0]<128)throw new Error("invalid rlp encoding: byte must be less 0x80");return{data:n,remainder:e.slice(r)}}if(a<=191){if(t=a-182,r=this.safeParseInt(e.slice(1,t).toString("hex"),16),(n=e.slice(t,r+t)).length<r)throw new Error("invalid RLP");return{data:n,remainder:e.slice(r+t)}}if(a<=247){for(r=a-191,o=e.slice(1,r);o.length;)i=this._decode(o),s.push(i.data),o=i.remainder;return{data:s,remainder:e.slice(r)}}var c=(t=a-246)+(r=this.safeParseInt(e.slice(1,t).toString("hex"),16));if(c>e.length)throw new Error("invalid rlp: total length is larger than the data");if(0===(o=e.slice(t,c)).length)throw new Error("invalid rlp, List has a invalid length");for(;o.length;)i=this._decode(o),s.push(i.data),o=i.remainder;return{data:s,remainder:e.slice(c)}},e.prototype.isHexPrefixed=function(e){return"0x"===e.slice(0,2)},e.prototype.stripHexPrefix=function(e){return"string"!=typeof e?e:this.isHexPrefixed(e)?e.slice(2):e},e.prototype.intToHex=function(e){var r=e.toString(16);return r.length%2&&(r="0"+r),r},e.prototype.padToEven=function(e){return e.length%2&&(e="0"+e),e},e.prototype.intToBuffer=function(e){var r=this.intToHex(e);return l.Buffer.from(r,"hex")},e.prototype.toBuffer=function(e){if(!l.Buffer.isBuffer(e))if("string"==typeof e)e=this.isHexPrefixed(e)?l.Buffer.from(this.padToEven(this.stripHexPrefix(e)),"hex"):l.Buffer.from(e);else if("number"==typeof e)e=e?this.intToBuffer(e):l.Buffer.from([]);else if(null===e||e===undefined)e=l.Buffer.from([]);else{if(!e.toArray)throw new Error("invalid type");e=l.Buffer.from(e.toArray())}return e},e.decorators=[{type:r.Injectable,args:[{providedIn:s}]}],e.ngInjectableDef=r.defineInjectable({factory:function(){return new e},token:e,providedIn:s}),e}(),c=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var o in r=arguments[t])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e};function f(e,r){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var n,o,i=t.call(e),s=[];try{for(;(void 0===r||0<r--)&&!(n=i.next()).done;)s.push(n.value)}catch(a){o={error:a}}finally{try{n&&!n.done&&(t=i["return"])&&t.call(i)}finally{if(o)throw o.error}}return s}function p(){for(var e=[],r=0;r<arguments.length;r++)e=e.concat(f(arguments[r]));return e}var u=function(){function e(e){this.rlp=e}return e.prototype.signTx=function(e,r,t){var n=this.rawTx(r),o=["0x"+(t||1).toString(16),"0x","0x"],i=this.rlp.encode(p(n,o)),s=b.keccak256(i),a=this.sign(e,s,t),c=a.r,f=a.s,u=a.v;return{messageHash:s,r:c,s:f,v:u,rawTransaction:"0x"+this.rlp.encode(p(n,[u,c,f])).toString("hex")}},e.prototype.recoverTx=function(e){},e.prototype.rawTx=function(e){return["0x"+(e.nonce||""),"0x"+(e.gasPrice||""),"0x"+(e.gas||""),"0x"+e.to.toLowerCase().replace("0x","")||"","0x"+(e.value||""),"0x"+(e.data||"")]},e.prototype.sign=function(e,r,t){var n=l.Buffer.from(e.replace("0x",""),"hex"),o=l.Buffer.from(r.replace("0x",""),"hex"),i=t&&0<t?2*t+8:0,s=h.sign(o,n),a=s.signature,c=s.recovery,f=a.toString("hex",0,32),u=a.toString("hex",32,64),p=(c+27+i).toString(16);return{r:"0x"+f,s:"0x"+u,v:"0x"+p,signature:"0x"+f+u+p}},e.prototype.hashMessage=function(e){var r=b.isHexStrict(e)?e:b.hexToBytes(e),t=l.Buffer.from(r),n="Ethereum Signed Message:\n"+r.length,o=l.Buffer.from(n),i=l.Buffer.concat([o,t]);return b.keccak256(i)},e.decorators=[{type:r.Injectable,args:[{providedIn:s}]}],e.ctorParameters=function(){return[{type:a}]},e.ngInjectableDef=r.defineInjectable({factory:function(){return new e(r.inject(a))},token:e,providedIn:s}),e}(),P=function(e){for(var r in this.salt=k.randomBytes(32),this.iv=k.randomBytes(16),this.kdf="scrypt",this.c=262144,this.dklen=32,this.n=8192,this.r=8,this.p=1,this.cipher="aes-128-ctr",this.uuid=k.randomBytes(16),e)this.hasOwnProperty(r)&&(this[r]=e[r]);e&&"string"==typeof e.salt&&(this.salt=Buffer.from(e.salt.replace("0x",""),"hex"))},d=function(){function e(){}return e.prototype.create=function(){for(var e;e=k.randomBytes(32),!h.privateKeyVerify(e););return this.fromPrivate(e)},e.prototype.fromPrivate=function(e){"string"==typeof e&&(e=Buffer.from([e.replace("0x","")]));var r=h.publicKeyCreate(e,!1).slice(1),t="0x"+b.keccak256(r).substring(26);return{privateKey:"0x"+e.toString("hex"),address:b.toChecksumAddress(t)}},e.prototype.encrypt=function(e,r,t){var n,o=Buffer.from(r),i=Buffer.from(e.replace("0x",""),"hex"),s=new P(t),a=s.salt,c=s.iv,f=s.kdf,u=s.c,p=s.n,l=s.r,h=s.p,d=s.dklen,y=s.cipher,g=s.uuid,v={dklen:d,salt:a.toString("hex")};if("pbkdf2"===f)v.c=u,v.prf="hmac-sha256",n=k.pbkdf2Sync(o,a,u,d,"sha256");else{if("scrypt"!==f)throw new Error("Unsupported Key Derivation Function"+f);v.n=p,v.r=l,v.p=h,n=S(o,a,p,l,h,d)}var x=k.createCipheriv(y,n.slice(0,16),c);if(!x)throw new Error("Unsupported cipher "+y);var m=Buffer.concat([x.update(i),x["final"]()]),w=Buffer.concat([n.slice(16,32),m]),B=b.keccak256(w).replace("0x","");return{version:3,id:j.v4({random:g}),address:this.fromPrivate(i).address.toLowerCase().replace("0x",""),crypto:{ciphertext:m.toString("hex"),cipherparams:{iv:c.toString("hex")},cipher:s.cipher,kdf:f,kdfparams:v,mac:B}}},e.prototype.decrypt=function(e,r){if("string"!=typeof r)throw new Error("No password provided");if("object"!=typeof e)throw new Error("keystore should be an object");if(3!==e.version)throw new Error("Not a V3 wallet");var t,n=e.crypto,o=n.kdf,i=n.kdfparams,s=n.cipherparams,a=n.cipher,c=Buffer.from(r,"utf8"),f=Buffer.from(i.salt,"hex"),u=Buffer.from(s.iv,"hex");if("scrypt"===o){var p=i.n,l=i.r,h=i.p,d=i.dklen;t=S(c,f,p,l,h,d)}else{if("pbkdf2"!==o)throw new Error("Unsupported key derivation scheme");if("hmac-sha256"!==i.prf)throw new Error("Unsupported parameters to PBKDF2");var y=i.c;d=i.dklen;t=k.pbkdf2Sync(c,f,y,d,"sha256")}var g=Buffer.from(e.crypto.ciphertext,"hex");if(b.keccak256(Buffer.concat([t.slice(16,32),g])).replace("0x","")!==e.crypto.mac)throw new Error("Key derivation failed - possibly wrong password");var v=k.createDecipheriv(a,t.slice(0,16),u),x=Buffer.concat([v.update(g),v["final"]()]);return this.fromPrivate(x)},e.decorators=[{type:r.Injectable,args:[{providedIn:s}]}],e.ctorParameters=function(){return[]},e.ngInjectableDef=r.defineInjectable({factory:function(){return new e},token:e,providedIn:s}),e}(),y=function(){function e(e,r,t){this.provider=e,this.signer=r,this.accounts=t,this.localKeystore=new o.BehaviorSubject(null),this.currentAccount=new o.BehaviorSubject(null),this.keystores$=this.localKeystore.asObservable(),this.account$=this.currentAccount.asObservable(),this.localKeystore.next(this.getKeystoreMapFromLocalStorage())}return Object.defineProperty(e.prototype,"defaultAccount",{get:function(){return this.currentAccount.getValue()},set:function(e){this.currentAccount.next(b.toChecksumAddress(e))},enumerable:!0,configurable:!0}),e.prototype.getKeystoreMapFromLocalStorage=function(){var i=this;return new Array(localStorage.length).fill(null).reduce(function(e,r,t){var n,o=localStorage.key(t);return b.checkAddressChecksum(o)?c({},e,((n={})[o]=i.getKeystore(o),n)):c({},e)},{})},e.prototype.getKeystore=function(e){var r=b.toChecksumAddress(e);return JSON.parse(localStorage.getItem(r))},e.prototype.getAccounts=function(){return this.keystores$.pipe(i.map(function(e){return Object.keys(e)}))},e.prototype.create=function(){return this.accounts.create()},e.prototype.save=function(e,r){var t=e.address,n=e.privateKey,o=this.encrypt(n,r);localStorage.setItem(t,JSON.stringify(o)),this.localKeystore.next(this.getKeystoreMapFromLocalStorage())},e.prototype.encrypt=function(e,r,t){return this.accounts.encrypt(e,r,t)},e.prototype.decrypt=function(e,r){return this.accounts.decrypt(e,r)},e.prototype.sendTransaction=function(e,r){var t=this.signTx(e,r).rawTransaction;return this.sendRawTransaction(t)},e.prototype.sendRawTransaction=function(e){return this.provider.rpc("eth_sendRawTransaction",[e])},e.prototype.signTx=function(e,r){return this.signer.signTx(r,e,this.provider.id)},e.prototype.sign=function(r,t,n){var o=this;return this.keystores$.pipe(i.map(function(e){return e[t]}),i.map(function(e){return o.decrypt(e,n)}),i.map(function(e){return o.signMessage(r,e.privateKey)}))},e.prototype.signMessage=function(e,r){var t=this.signer.hashMessage(e),n=this.signer.sign(r,t),o=n.r,i=n.s;return{message:e,messageHash:t,v:n.v,r:o,s:i,signature:n.signature}},e.decorators=[{type:r.Injectable,args:[{providedIn:t.ProvidersModule}]}],e.ctorParameters=function(){return[{type:t.MainProvider},{type:u},{type:d}]},e.ngInjectableDef=r.defineInjectable({factory:function(){return new e(r.inject(t.MainProvider),r.inject(u),r.inject(d))},token:e,providedIn:t.ProvidersModule}),e}();e.WalletModule=s,e.RLP=a,e.Signer=u,e.Wallet=y,e.ɵc=d,e.ɵb=a,e.ɵa=u,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=ngeth-wallet.umd.min.js.map